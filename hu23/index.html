<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Volleyball-Slot Buchung</title>
  <style>
    body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f2f2f2; margin: 0; padding: 0; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; }
    .container { background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 20px; max-width: 500px; width: 100%; margin: 40px 10px; }
    h1 { font-size: 1.8rem; margin-bottom: 20px; text-align: center; color: #333; }
    label { display: block; margin-top: 12px; font-weight: bold; color: #555; }
    select, input[type="email"] { width: 100%; padding: 8px; margin-top: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; }
    .slots { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px,1fr)); gap: 10px; margin-top: 10px; }
    .slot-card { position: relative; }
    .slot-card input[type=radio] { display: none; }
    .slot-card label { display: block; padding: 12px; border: 1px solid #ccc; border-radius: 4px; background: #e9ecef; text-align: center; cursor: pointer; transition: background 0.2s, color 0.2s, border-color 0.2s; }
    .slot-card input[type=radio]:checked + label { background: #007bff; color: #fff; border-color: #0056b3; }
    button { width: 100%; padding: 12px; margin-top: 20px; font-size: 1rem; background: #007bff; color: #fff; border: none; border-radius: 4px; cursor: pointer; transition: background 0.2s; }
    button:disabled { background: #aaa; cursor: not-allowed; }
    #responseMessage { margin-top: 15px; padding: 10px; border-radius: 4px; font-weight: bold; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Volleyball-Slot buchen</h1>
    <form id="bookingForm" onsubmit="submitForm(); return false;">
      <label for="teamName">Team auswählen *</label>
      <select id="teamName" required>
        <option value="">-- Bitte wählen --</option>
        <option>Volley Oerlikon H2</option>
        <option>VBC Rämi H2</option>
        <option>VBC Wetzikon H2</option>
        <option>VBC Volewa Wald H1</option>
        <option>VBC Voléro Zürich 4</option>
        <option>Volley Uster H2</option>
        <option>VBC Stäfa H1</option>
        <option>VC Tornado Adliswil H1</option>
      </select>
      <label for="teamEmail">Team-E-Mail *</label>
      <input type="email" id="teamEmail" required placeholder="beispiel@domain.de">
      <label>Verfügbare Termine *</label>
      <div class="slots" id="slotsContainer"></div>
      <button type="submit" id="bookBtn" disabled>Buchen</button>
    </form>
    <div id="responseMessage"></div>
  </div>
  <script>
    // Configuration
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwHeOAzodKSKQ5Sdg28yJXW62Gc8ykduHtiiWwBJ-LCs7xxtUps3BdMEQh9kJ1i64vu/exec';
    const validSheets = ['H3', 'HU23'];

    // Determine sheet from URL path or query
    const params = new URLSearchParams(window.location.search);
    let sheetParam = params.get('sheet') || '';
    if (!sheetParam) {
      // Try path segment
      const pathPart = window.location.pathname.split('/').filter(Boolean).pop();
      if (validSheets.includes(pathPart)) sheetParam = pathPart;
    }
    if (!validSheets.includes(sheetParam)) sheetParam = 'H3';

    let slots = [];
    const weekdays = ['So','Mo','Di','Mi','Do','Fr','Sa'];

    document.addEventListener('DOMContentLoaded', loadSlots);
    function loadSlots() {
      fetch(`${WEB_APP_URL}?action=getSlots&sheetName=${encodeURIComponent(sheetParam)}`)
        .then(r => r.json())
        .then(data => { slots = data; renderSlots(); })
        .catch(() => showError('Fehler beim Laden der Termine.'));
    }
    function renderSlots() {
      const container = document.getElementById('slotsContainer');
      container.innerHTML = '';
      clearResponse();
      if (!slots.length) return showError('Keine freien Termine verfügbar.');
      document.getElementById('bookBtn').disabled = true;
      slots.forEach(slot => {
        const [dd, mm, yyyy] = slot.date.split('/');
        const dayName = weekdays[new Date(yyyy, mm-1, dd).getDay()];
        const id = `slot_${slot.id}`;
        const card = document.createElement('div');
        card.className = 'slot-card';
        card.innerHTML = `
          <input type="radio" name="slot" id="${id}" value="${slot.id}" />
          <label for="${id}"><strong>${slot.date} (${dayName})</strong><br>${slot.time}</label>
        `;
        card.querySelector('input').addEventListener('change', () => {
          document.getElementById('bookBtn').disabled = false;
        });
        container.appendChild(card);
      });
    }
    function submitForm() {
      const team = document.getElementById('teamName').value;
      const email = document.getElementById('teamEmail').value.trim();
      const selected = document.querySelector('input[name="slot"]:checked');
      if (!team || !email || !selected) return showError('Bitte alle Felder ausfüllen und einen Termin wählen.');
      const btn = document.getElementById('bookBtn'); btn.disabled = true; btn.textContent = 'Bucht…';
      const qs = new URLSearchParams({ action:'book', slotId:selected.value, teamName:team, teamEmail:email, sheetName:sheetParam });
      fetch(`${WEB_APP_URL}?${qs}`)
        .then(r=>r.json())
        .then(res=>{ if(res.error) showError(`Fehler: ${res.error}`); else showSuccess(res.message); btn.textContent='Buchen'; btn.disabled=true; loadSlots(); })
        .catch(()=>showError('Kritischer Fehler beim Buchen.'));
    }
    function showError(msg){ const e=document.getElementById('responseMessage'); e.textContent=msg; e.className='error'; }
    function showSuccess(msg){ const e=document.getElementById('responseMessage'); e.textContent=msg; e.className='success'; }
    function clearResponse(){ const e=document.getElementById('responseMessage'); e.textContent=''; e.className=''; }
  </script>
</body>
</html>
